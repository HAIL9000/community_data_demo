<head>
  <meta charset="utf-8">
  <title>Puppet Pull Request Metrics</title>
  <style type = "text/css">

      #barGraph {
        margin-left: 10px;
      }

      .axis path,
      .axis line {
            fill: none;
            stroke: black;
            stroke-width: 1px;
            shape-rendering: crispEdges;
         }

      .axis text {
        font-family: sans-serif;
        font-size: 11px;
        }
  </style>
  <script src="js/d3.v3/d3.v3.js"></script>
  <script src ="js/crossfilter-1.2.0/crossfilter.min.js"></script>
  <script src="js/dc.js-1.4.0/dc.js"></script>
  <link type="text/css" rel="stylesheet" href="css/dc.css"/>
</head>
  <script type="text/javascript">
      d3.json('/data/puppet_pulls', function(dataset) {
          var dateFormat = d3.time.format.utc('%Y-%m-%dT%H:%M:%SZ');

          dataset = dataset.map(function(d){
            return {'time': d3.time.month(dateFormat.parse(d.close_time)),
            'repo': d.repo_name};
            });

          time_domain = d3.extent(dataset, function(d){return d.time;});

          var pull_requests = crossfilter(dataset);
          var all = pull_requests.groupAll();

          var timeDimension = pull_requests.dimension(function(d){return d.time;});
          var timeGroup = timeDimension.group().reduceCount().orderNatural();

          var repoDimension = pull_requests.dimension(function(d){return d.repo;});
          var repoGroup = repoDimension.group().reduceCount().orderNatural();

          var chart = dc.barChart("#per-month")
            .width(900)
            .height(250)
            .gap(2)
            .dimension(timeDimension)
            .group(timeGroup)
            .centerBar(true)
            .x(d3.time.scale().domain(time_domain))
            .xUnits(d3.time.months);

          chart.xAxis().ticks(d3.time.months, 2)
                       .tickFormat(d3.time.format("%b %Y"));

          var repoChart = dc.rowChart("#repo-names")
            .width(300)
            .height(180)
            .group(repoGroup)
            .dimension(repoDimension)
            .colors(['#6600FF', '#934BFF', '#AF7AFF', '#DAC2FF']);

          repoChart.xAxis().ticks(5);

          dc.renderAll();
      });
   </script>

   <div id='per-month'></div>
   <div id='repo-names'></div>
</body>
